<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>decocare.history &mdash; insulaudit:decoding-carelink 0.0.3 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="insulaudit:decoding-carelink 0.0.3 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">insulaudit:decoding-carelink 0.0.3 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for decocare.history</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides some basic helper/formatting utilities,</span>
<span class="sd">specifically targeted at decoding ReadHistoryData data.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span>

<span class="kn">import</span> <span class="nn">lib</span>
<span class="kn">from</span> <span class="nn">records</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">_remote_ids</span> <span class="o">=</span> <span class="p">[</span>
  <span class="nb">bytearray</span><span class="p">([</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">]),</span>
  <span class="nb">bytearray</span><span class="p">([</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x2a</span> <span class="p">]),</span>
  <span class="nb">bytearray</span><span class="p">([</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x92</span> <span class="p">]),</span>
<span class="p">]</span>

<div class="viewcode-block" id="decode_remote_id"><a class="viewcode-back" href="../../api/history.html#decocare.history.decode_remote_id">[docs]</a><span class="k">def</span> <span class="nf">decode_remote_id</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  practice decoding some remote ids:</span>

<span class="sd">  | 0x27</span>
<span class="sd">  | 0x01 0xe2 0x40</span>
<span class="sd">  | 0x03 0x42 0x2a</span>
<span class="sd">  | 0x28 0x0c 0x89</span>
<span class="sd">  | 0x92 0x00 0x00 0x00</span>

<span class="sd">  &gt;&gt;&gt; decode_remote_id(_remote_ids[0])</span>
<span class="sd">  &#39;123456&#39;</span>

<span class="sd">  &gt;&gt;&gt; decode_remote_id(_remote_ids[1])</span>
<span class="sd">  &#39;213546&#39;</span>

<span class="sd">  &gt;&gt;&gt; decode_remote_id(_remote_ids[2])</span>
<span class="sd">  &#39;821650&#39;</span>



<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">high</span>   <span class="o">=</span> <span class="n">msg</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">256</span>
  <span class="n">middle</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
  <span class="n">low</span>    <span class="o">=</span> <span class="n">msg</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span>
  <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">middle</span> <span class="o">+</span> <span class="n">low</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NoDelivery"><a class="viewcode-back" href="../../api/history.html#decocare.history.NoDelivery">[docs]</a><span class="k">class</span> <span class="nc">NoDelivery</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x06</span>
  <span class="n">head_length</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c">#class ResultTotals(KnownRecord):</span></div>
<div class="viewcode-block" id="MResultTotals"><a class="viewcode-back" href="../../api/history.html#decocare.history.MResultTotals">[docs]</a><span class="k">class</span> <span class="nc">MResultTotals</span><span class="p">(</span><span class="n">InvalidRecord</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;On 722 this seems like two records.&quot;&quot;&quot;</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x07</span>
  <span class="c">#head_length = 5</span>
  <span class="n">head_length</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="n">date_length</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="c">#body_length = 37 + 4</span>
  <span class="c">#body_length = 2</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">larger</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">larger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">larger</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">body_length</span> <span class="o">=</span> <span class="mi">3</span>
<div class="viewcode-block" id="MResultTotals.parse_time"><a class="viewcode-back" href="../../api/history.html#decocare.history.MResultTotals.parse_time">[docs]</a>  <span class="k">def</span> <span class="nf">parse_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">unmask_m_midnight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">mid</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">date</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">lib</span><span class="o">.</span><span class="n">hexdump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
      <span class="k">pass</span>
    <span class="k">return</span> <span class="n">mid</span>
      
    </div>
<div class="viewcode-block" id="MResultTotals.date_str"><a class="viewcode-back" href="../../api/history.html#decocare.history.MResultTotals.date_str">[docs]</a>  <span class="k">def</span> <span class="nf">date_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;unknown&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unmask_m_midnight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>
</div></div>
<div class="viewcode-block" id="ChangeBasalProfile"><a class="viewcode-back" href="../../api/history.html#decocare.history.ChangeBasalProfile">[docs]</a><span class="k">class</span> <span class="nc">ChangeBasalProfile</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x08</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">44</span></div>
<div class="viewcode-block" id="ClearAlarm"><a class="viewcode-back" href="../../api/history.html#decocare.history.ClearAlarm">[docs]</a><span class="k">class</span> <span class="nc">ClearAlarm</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x0C</span></div>
<div class="viewcode-block" id="SelectBasalProfile"><a class="viewcode-back" href="../../api/history.html#decocare.history.SelectBasalProfile">[docs]</a><span class="k">class</span> <span class="nc">SelectBasalProfile</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x14</span></div>
<div class="viewcode-block" id="ChangeTime"><a class="viewcode-back" href="../../api/history.html#decocare.history.ChangeTime">[docs]</a><span class="k">class</span> <span class="nc">ChangeTime</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x17</span></div>
<div class="viewcode-block" id="NewTimeSet"><a class="viewcode-back" href="../../api/history.html#decocare.history.NewTimeSet">[docs]</a><span class="k">class</span> <span class="nc">NewTimeSet</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x18</span></div>
<div class="viewcode-block" id="LowBattery"><a class="viewcode-back" href="../../api/history.html#decocare.history.LowBattery">[docs]</a><span class="k">class</span> <span class="nc">LowBattery</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x19</span></div>
<div class="viewcode-block" id="Battery"><a class="viewcode-back" href="../../api/history.html#decocare.history.Battery">[docs]</a><span class="k">class</span> <span class="nc">Battery</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x1a</span></div>
<div class="viewcode-block" id="PumpSuspend"><a class="viewcode-back" href="../../api/history.html#decocare.history.PumpSuspend">[docs]</a><span class="k">class</span> <span class="nc">PumpSuspend</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x1e</span></div>
<div class="viewcode-block" id="PumpResume"><a class="viewcode-back" href="../../api/history.html#decocare.history.PumpResume">[docs]</a><span class="k">class</span> <span class="nc">PumpResume</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x1f</span>
</div>
<div class="viewcode-block" id="Rewind"><a class="viewcode-back" href="../../api/history.html#decocare.history.Rewind">[docs]</a><span class="k">class</span> <span class="nc">Rewind</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x21</span></div>
<div class="viewcode-block" id="EnableDisableRemote"><a class="viewcode-back" href="../../api/history.html#decocare.history.EnableDisableRemote">[docs]</a><span class="k">class</span> <span class="nc">EnableDisableRemote</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x26</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">14</span></div>
<div class="viewcode-block" id="ChangeRemoteID"><a class="viewcode-back" href="../../api/history.html#decocare.history.ChangeRemoteID">[docs]</a><span class="k">class</span> <span class="nc">ChangeRemoteID</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x27</span>
</div>
<div class="viewcode-block" id="TempBasalDuration"><a class="viewcode-back" href="../../api/history.html#decocare.history.TempBasalDuration">[docs]</a><span class="k">class</span> <span class="nc">TempBasalDuration</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x16</span>
  <span class="n">_test_1</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span> <span class="p">])</span>
<div class="viewcode-block" id="TempBasalDuration.decode"><a class="viewcode-back" href="../../api/history.html#decocare.history.TempBasalDuration.decode">[docs]</a>  <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parse_time</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">basal</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;duration (min)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">basal</span></div></div>
<div class="viewcode-block" id="TempBasal"><a class="viewcode-back" href="../../api/history.html#decocare.history.TempBasal">[docs]</a><span class="k">class</span> <span class="nc">TempBasal</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x33</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">_test_1</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span> <span class="p">])</span>
<div class="viewcode-block" id="TempBasal.decode"><a class="viewcode-back" href="../../api/history.html#decocare.history.TempBasal.decode">[docs]</a>  <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parse_time</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">basal</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">40.0</span><span class="p">,</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">basal</span>
</div></div>
<div class="viewcode-block" id="LowReservoir"><a class="viewcode-back" href="../../api/history.html#decocare.history.LowReservoir">[docs]</a><span class="k">class</span> <span class="nc">LowReservoir</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  &gt;&gt;&gt; rec = LowReservoir( LowReservoir._test_1[:2] )</span>
<span class="sd">  &gt;&gt;&gt; decoded = rec.parse(LowReservoir._test_1)</span>
<span class="sd">  &gt;&gt;&gt; print str(rec)</span>
<span class="sd">  LowReservoir 2012-12-07T11:02:43 head[2], body[0] op[0x34]</span>

<span class="sd">  &gt;&gt;&gt; print pformat(decoded)</span>
<span class="sd">  {&#39;amount&#39;: 20.0}</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x34</span>
  <span class="n">_test_1</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span>
                        <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="p">])</span>
<div class="viewcode-block" id="LowReservoir.decode"><a class="viewcode-back" href="../../api/history.html#decocare.history.LowReservoir.decode">[docs]</a>  <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parse_time</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">reservoir</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;amount&#39;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">reservoir</span>

</div></div>
<div class="viewcode-block" id="ChangeUtility"><a class="viewcode-back" href="../../api/history.html#decocare.history.ChangeUtility">[docs]</a><span class="k">class</span> <span class="nc">ChangeUtility</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x63</span></div>
<div class="viewcode-block" id="ChangeTimeDisplay"><a class="viewcode-back" href="../../api/history.html#decocare.history.ChangeTimeDisplay">[docs]</a><span class="k">class</span> <span class="nc">ChangeTimeDisplay</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x64</span>
</div>
<span class="n">_confirmed</span> <span class="o">=</span> <span class="p">[</span> <span class="n">Bolus</span><span class="p">,</span> <span class="n">Prime</span><span class="p">,</span> <span class="n">NoDelivery</span><span class="p">,</span> <span class="n">MResultTotals</span><span class="p">,</span> <span class="n">ChangeBasalProfile</span><span class="p">,</span>
               <span class="n">ClearAlarm</span><span class="p">,</span> <span class="n">SelectBasalProfile</span><span class="p">,</span> <span class="n">TempBasalDuration</span><span class="p">,</span> <span class="n">ChangeTime</span><span class="p">,</span>
               <span class="n">NewTimeSet</span><span class="p">,</span> <span class="n">LowBattery</span><span class="p">,</span> <span class="n">Battery</span><span class="p">,</span> <span class="n">PumpSuspend</span><span class="p">,</span>
               <span class="n">PumpResume</span><span class="p">,</span> <span class="n">CalBGForPH</span><span class="p">,</span> <span class="n">Rewind</span><span class="p">,</span> <span class="n">EnableDisableRemote</span><span class="p">,</span>
               <span class="n">ChangeRemoteID</span><span class="p">,</span> <span class="n">TempBasal</span><span class="p">,</span> <span class="n">LowReservoir</span><span class="p">,</span> <span class="n">BolusWizard</span><span class="p">,</span>
               <span class="n">UnabsorbedInsulinBolus</span><span class="p">,</span> <span class="n">ChangeUtility</span><span class="p">,</span> <span class="n">ChangeTimeDisplay</span> <span class="p">]</span>

<div class="viewcode-block" id="Ian69"><a class="viewcode-back" href="../../api/history.html#decocare.history.Ian69">[docs]</a><span class="k">class</span> <span class="nc">Ian69</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x69</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">2</span></div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ian69</span><span class="p">)</span>

<div class="viewcode-block" id="Ian50"><a class="viewcode-back" href="../../api/history.html#decocare.history.Ian50">[docs]</a><span class="k">class</span> <span class="nc">Ian50</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x50</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">34</span></div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ian50</span><span class="p">)</span>

<div class="viewcode-block" id="Ian54"><a class="viewcode-back" href="../../api/history.html#decocare.history.Ian54">[docs]</a><span class="k">class</span> <span class="nc">Ian54</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x54</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">34</span> <span class="o">+</span> <span class="mi">23</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">57</span></div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ian54</span><span class="p">)</span>

<div class="viewcode-block" id="Ian0B"><a class="viewcode-back" href="../../api/history.html#decocare.history.Ian0B">[docs]</a><span class="k">class</span> <span class="nc">Ian0B</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x0B</span>
  <span class="n">head_length</span> <span class="o">=</span> <span class="mi">3</span></div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ian0B</span><span class="p">)</span>

<div class="viewcode-block" id="Ian3F"><a class="viewcode-back" href="../../api/history.html#decocare.history.Ian3F">[docs]</a><span class="k">class</span> <span class="nc">Ian3F</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x3F</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">3</span></div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ian3F</span><span class="p">)</span>

<div class="viewcode-block" id="IanA8"><a class="viewcode-back" href="../../api/history.html#decocare.history.IanA8">[docs]</a><span class="k">class</span> <span class="nc">IanA8</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0xA8</span>
  <span class="n">head_length</span> <span class="o">=</span> <span class="mi">10</span></div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IanA8</span><span class="p">)</span>

<div class="viewcode-block" id="BasalProfileStart"><a class="viewcode-back" href="../../api/history.html#decocare.history.BasalProfileStart">[docs]</a><span class="k">class</span> <span class="nc">BasalProfileStart</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x7b</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">3</span></div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BasalProfileStart</span><span class="p">)</span>

<div class="viewcode-block" id="old6c"><a class="viewcode-back" href="../../api/history.html#decocare.history.old6c">[docs]</a><span class="k">class</span> <span class="nc">old6c</span><span class="p">(</span><span class="n">InvalidRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x6c</span>
  <span class="c">#head_length = 45</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">38</span>
  <span class="c"># body_length = 34</span></div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old6c</span><span class="p">)</span>

<div class="viewcode-block" id="Model522ResultTotals"><a class="viewcode-back" href="../../api/history.html#decocare.history.Model522ResultTotals">[docs]</a><span class="k">class</span> <span class="nc">Model522ResultTotals</span><span class="p">(</span><span class="n">KnownRecord</span><span class="p">):</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x6d</span>
  <span class="n">head_length</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">date_length</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">40</span>
<div class="viewcode-block" id="Model522ResultTotals.parse_time"><a class="viewcode-back" href="../../api/history.html#decocare.history.Model522ResultTotals.parse_time">[docs]</a>  <span class="k">def</span> <span class="nf">parse_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">unmask_m_midnight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">mid</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">date</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">lib</span><span class="o">.</span><span class="n">hexdump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
      <span class="k">pass</span>
    <span class="k">return</span> <span class="n">mid</span>
      
    </div>
<div class="viewcode-block" id="Model522ResultTotals.date_str"><a class="viewcode-back" href="../../api/history.html#decocare.history.Model522ResultTotals.date_str">[docs]</a>  <span class="k">def</span> <span class="nf">date_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;unknown&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unmask_m_midnight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>
</div></div>
<div class="viewcode-block" id="unmask_m_midnight"><a class="viewcode-back" href="../../api/history.html#decocare.history.unmask_m_midnight">[docs]</a><span class="k">def</span> <span class="nf">unmask_m_midnight</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Extract date values from a series of bytes.</span>
<span class="sd">  Always returns tuple given a bytearray of at least 3 bytes.</span>

<span class="sd">  Returns 6-tuple of scalar values year, month, day, hours, minutes,</span>
<span class="sd">  seconds.</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:]</span>
  <span class="n">seconds</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">minutes</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">hours</span>   <span class="o">=</span> <span class="mi">0</span>

  <span class="n">day</span>     <span class="o">=</span> <span class="n">parse_day</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

  <span class="n">high</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
  <span class="n">low</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span>

  <span class="n">year_high</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
  <span class="c"># month = int(high) #+ year_high</span>
  <span class="c"># month   = parse_months( data[0], data[1] )</span>
  <span class="n">mhigh</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
  <span class="n">mlow</span>  <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span>
  <span class="n">month</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">mhigh</span> <span class="o">+</span> <span class="n">mlow</span><span class="p">)</span>
  <span class="n">day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">low</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="n">year</span> <span class="o">=</span> <span class="n">parse_years</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span>
</div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Model522ResultTotals</span><span class="p">)</span>

<div class="viewcode-block" id="Sara6E"><a class="viewcode-back" href="../../api/history.html#decocare.history.Sara6E">[docs]</a><span class="k">class</span> <span class="nc">Sara6E</span><span class="p">(</span><span class="n">Model522ResultTotals</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Seems specific to 722?&quot;&quot;&quot;</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x6e</span>
  <span class="c">#head_length = 52 - 5</span>
  <span class="c"># body_length = 1</span>
  <span class="n">body_length</span> <span class="o">=</span> <span class="mi">48</span>
  <span class="c">#body_length = 0</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">larger</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">larger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">larger</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">body_length</span> <span class="o">=</span> <span class="mi">48</span></div>
<span class="n">_confirmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sara6E</span><span class="p">)</span>

<span class="n">_known</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>

<span class="n">_variant</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_confirmed</span><span class="p">:</span>
  <span class="n">_known</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">opcode</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

<span class="k">del</span> <span class="n">x</span>

<div class="viewcode-block" id="suggest"><a class="viewcode-back" href="../../api/history.html#decocare.history.suggest">[docs]</a><span class="k">def</span> <span class="nf">suggest</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">larger</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Look in the known table of commands to find a suitable record type</span>
<span class="sd">  for this opcode.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">klass</span> <span class="o">=</span> <span class="n">_known</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Base</span><span class="p">)</span>
  <span class="n">record</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">larger</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">record</span>
</div>
<div class="viewcode-block" id="parse_record"><a class="viewcode-back" href="../../api/history.html#decocare.history.parse_record">[docs]</a><span class="k">def</span> <span class="nf">parse_record</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span> <span class="p">),</span> <span class="n">larger</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Given a file-like object, and the head of a record, parse the rest</span>
<span class="sd">  of the record.</span>
<span class="sd">  Look up the type of record, read in just enough data to parse it,</span>
<span class="sd">  return the result.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c"># head    = bytearray(fd.read(2))</span>
  <span class="n">date</span>    <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span> <span class="p">)</span>
  <span class="n">body</span>    <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span> <span class="p">)</span>
  <span class="n">record</span>  <span class="o">=</span> <span class="n">suggest</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">larger</span><span class="p">)</span>
  <span class="n">remaining</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">head_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">head</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">remaining</span><span class="p">)))</span>
  <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">date_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">date</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">date_length</span><span class="p">)))</span>
  <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">body_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">body_length</span><span class="p">)))</span>
  <span class="n">record</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="n">head</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="n">body</span> <span class="p">)</span>
  <span class="c"># print str(record)</span>
  <span class="c"># print record.pformat(prefix=str(record) )</span>
  <span class="k">return</span> <span class="n">record</span>

</div>
<div class="viewcode-block" id="describe"><a class="viewcode-back" href="../../api/history.html#decocare.history.describe">[docs]</a><span class="k">def</span> <span class="nf">describe</span><span class="p">(</span> <span class="p">):</span>
  <span class="n">keys</span> <span class="o">=</span> <span class="n">_known</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span> <span class="p">)</span>
  <span class="n">out</span>  <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_known</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span> <span class="p">))</span>
  <span class="k">return</span> <span class="n">out</span>

    
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">doctest</span>
  <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span> <span class="p">)</span>

<span class="c">#####</span>
<span class="c"># EOF</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">insulaudit:decoding-carelink 0.0.3 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Insulaudit contributors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>